// ========================================
// SPOTIFY INTEGRATION
// ========================================

import { spotifyPlayer } from './spotify-player.js';

// ========================================
// STATE MANAGEMENT
// ========================================

const state = {
    temperature: 78,
    isLighting: false,
    isPlaying: false,
    spotifyEnabled: false,
    currentService: 'spotify', // Track which service is active
    independentPlayer: null, // Will be initialized when independent is selected
};

// ========================================
// INITIALIZATION & EVENT LISTENERS
// ========================================

document.addEventListener('DOMContentLoaded', async () => {
    // Initialize Spotify
    await spotifyPlayer.init();
    updateSpotifyStatus();

    // ========================================
    // DOM ELEMENTS (Load after DOM is ready)
    // ========================================
    
    const elements = {
        toggleLights: document.getElementById('toggleLights'),
        lightingStatus: document.getElementById('lightingStatus'),
        temperatureDisplay: document.getElementById('temperatureDisplay'),
        increaseTemp: document.getElementById('increaseTemp'),
        decreaseTemp: document.getElementById('decreaseTemp'),
        playPause: document.getElementById('playPause'),
        nextTrack: document.getElementById('nextTrack'),
        previousTrack: document.getElementById('previousTrack'),
        songName: document.getElementById('songName'),
        songAlbum: document.getElementById('songAlbum'),
        songImage: document.getElementById('songImage'),
        musicServiceSelect: document.getElementById('musicServiceSelect'),
    };
    
    // ========================================
    // UTILITY FUNCTIONS
    // ========================================
    
    const updateTemperatureDisplay = () => {
        elements.temperatureDisplay.textContent = `${state.temperature}°F`;
    };
    
    const updateLightingStatus = () => {
        state.isLighting = elements.toggleLights.checked;
        elements.lightingStatus.textContent = state.isLighting ? 'On' : 'Off';
    };

    const updateSpotifyStatus = () => {
        const isAuth = spotifyPlayer.isAuthenticated;
        state.spotifyEnabled = isAuth;
        
        if (isAuth) {
            elements.spotifyStatus.textContent = 'Connected to Spotify';
            elements.spotifyStatus.classList.add('connected');
            elements.spotifyLoginBtn.textContent = 'Logout';
            elements.spotifyLoginBtn.classList.add('logout-btn');
        } else {
            elements.spotifyStatus.textContent = 'Not Connected';
            elements.spotifyStatus.classList.remove('connected');
            elements.spotifyLoginBtn.textContent = '♪ Login';
            elements.spotifyLoginBtn.classList.remove('logout-btn');
        }
    };

    const updateNowPlaying = () => {
        const trackInfo = spotifyPlayer.getCurrentTrackInfo();
        
        elements.songName.textContent = trackInfo.name;
        elements.songArtist.textContent = trackInfo.artist;
        elements.songAlbum.textContent = trackInfo.album;
        
        if (trackInfo.imageUrl) {
            elements.songImage.innerHTML = `<img src="${trackInfo.imageUrl}" alt="Album art">`;
        } else {
            elements.songImage.innerHTML = '<i class="fas fa-music"></i>';
        }
        
        // Update play button
        if (spotifyPlayer.isPlaying) {
            elements.playPause.innerHTML = '<i class="fas fa-pause"></i><span>Pause</span>';
        } else {
            elements.playPause.innerHTML = '<i class="fas fa-play"></i><span>Play</span>';
        }
    };

    const refreshPlaybackState = async () => {
        try {
            if (state.currentService === 'spotify' && state.spotifyEnabled) {
                await spotifyPlayer.getPlaybackState();
                
            } else if (state.currentService === 'independent' && state.independentPlayer) {
                // Independent player updates internally
                
            } else if (state.currentService === 'appleMusic' && appleMusicPlayer.isInitialized) {
                // Apple Music player updates internally
            }
            
            updateNowPlaying();
        } catch (error) {
            console.error('Error refreshing playback state:', error);
        }
    };
    
    // Initialize displays
    updateTemperatureDisplay();
    updateLightingStatus();
    
    // ========================================
    // EVENT LISTENERS - LIGHTING
    // ========================================
    
    elements.toggleLights.addEventListener('change', () => {
        updateLightingStatus();
        console.log(`Lights ${state.isLighting ? 'turned ON' : 'turned OFF'}`);
    });
    
    // ========================================
    // EVENT LISTENERS - TEMPERATURE
    // ========================================
    
    elements.increaseTemp.addEventListener('click', () => {
        state.temperature++;
        updateTemperatureDisplay();
        console.log(`Temperature increased to ${state.temperature}°F`);
    });
    
    elements.decreaseTemp.addEventListener('click', () => {
        state.temperature--;
        updateTemperatureDisplay();
        console.log(`Temperature decreased to ${state.temperature}°F`);
    });
    
    // ========================================
    // EVENT LISTENERS - MUSIC SERVICE SELECTOR
    // ========================================
    
    elements.musicServiceSelect?.addEventListener('change', async (e) => {
        const selectedService = e.target.value;
        console.log(`Switching to ${selectedService} service...`);
        await switchMusicService(selectedService);
    });
    
    // ========================================
    // EVENT LISTENERS - MUSIC PLAYBACK
    // ========================================
    
    elements.playPause.addEventListener('click', async () => {
        await handlePlayPause();
    });
    
    elements.nextTrack.addEventListener('click', async () => {
        await handleNextTrack();
    });

    elements.previousTrack.addEventListener('click', async () => {
        await handlePreviousTrack();
    });
    
    
    // ========================================
    // MUSIC SERVICE HANDLERS
    // ========================================
    
    async function switchMusicService(service) {
        state.currentService = service;
        
        try {
            if (service === 'independent') {
                // Initialize Independent Music Player if not already done
                if (!state.independentPlayer) {
                    state.independentPlayer = new IndependentMusicPlayer();
                    await state.independentPlayer.initialize();
                    console.log('Independent Music Player initialized');
                }
                console.log('Switched to Independent Artists service');
                elements.songName.textContent = 'Select a track';
                elements.songAlbum.textContent = 'Independent Artists & Creative Commons';
                
            } else if (service === 'spotify') {
                // Spotify requires login
                if (!state.spotifyEnabled) {
                    console.log('Spotify selected - please login');
                    elements.songName.textContent = 'Spotify Selected';
                    elements.songAlbum.textContent = 'Click login to connect';
                    await spotifyPlayer.login();
                } else {
                    console.log('Switched to Spotify');
                }
                
            } else if (service === 'appleMusic') {
                // Apple Music requires login
                if (!appleMusicPlayer.isInitialized) {
                    console.log('Apple Music selected - initializing...');
                    elements.songName.textContent = 'Apple Music Selected';
                    elements.songAlbum.textContent = 'Connecting...';
                    try {
                        await appleMusicPlayer.initialize();
                        console.log('Apple Music initialized');
                    } catch (error) {
                        console.error('Apple Music initialization failed:', error);
                        elements.songAlbum.textContent = 'Connection failed';
                    }
                }
            }
            
            await refreshPlaybackState();
        } catch (error) {
            console.error(`Error switching to ${service}:`, error);
        }
    }
    
    async function handlePlayPause() {
        try {
            if (state.currentService === 'independent') {
                if (!state.independentPlayer) {
                    state.independentPlayer = new IndependentMusicPlayer();
                    await state.independentPlayer.initialize();
                    
                    // Load demo tracks on first initialization
                    const demoTracks = state.independentPlayer.getDemoTracks();
                    state.independentPlayer.setPlaylist(demoTracks);
                    elements.songName.textContent = 'Loading demo tracks...';
                    elements.songAlbum.textContent = 'Independent Artists';
                }
                
                if (state.independentPlayer.isPlaying) {
                    await state.independentPlayer.pause();
                } else {
                    // If no current track, play first track in playlist
                    if (!state.independentPlayer.currentTrack && state.independentPlayer.playlist.length > 0) {
                        await state.independentPlayer.play(state.independentPlayer.playlist[0]);
                    } else if (state.independentPlayer.currentTrack) {
                        await state.independentPlayer.play();
                    } else {
                        console.log('No tracks available');
                        elements.songName.textContent = 'No tracks available';
                        return;
                    }
                }
                
            } else if (state.currentService === 'spotify') {
                if (!state.spotifyEnabled) {
                    console.log('Please login to Spotify first');
                    elements.songName.textContent = 'Spotify Login Required';
                    elements.songAlbum.textContent = 'Click the service selector to login';
                    return;
                }
                
                if (spotifyPlayer.isPlaying) {
                    await spotifyPlayer.pause();
                } else {
                    // If no current track, play something or show instructions
                    if (!spotifyPlayer.currentTrack) {
                        console.log('Starting Spotify playback...');
                        elements.songName.textContent = 'Starting Spotify...';
                    }
                    await spotifyPlayer.play();
                }
                
            } else if (state.currentService === 'appleMusic') {
                if (!appleMusicPlayer.isInitialized) {
                    console.log('Please initialize Apple Music first');
                    elements.songName.textContent = 'Apple Music Setup Required';
                    elements.songAlbum.textContent = 'Click the service selector to connect';
                    return;
                }
                
                if (appleMusicPlayer.isPlaying) {
                    appleMusicPlayer.pause();
                } else {
                    // If no current track, play something or show instructions
                    if (!appleMusicPlayer.currentTrack) {
                        console.log('Starting Apple Music playback...');
                        elements.songName.textContent = 'Starting Apple Music...';
                    }
                    appleMusicPlayer.play();
                }
            }
            
            await refreshPlaybackState();
        } catch (error) {
            console.error('Play/Pause error:', error);
            elements.songName.textContent = 'Playback Error';
            elements.songAlbum.textContent = error.message;
        }
    }
    
    async function handleNextTrack() {
        try {
            if (state.currentService === 'independent') {
                if (!state.independentPlayer) {
                    state.independentPlayer = new IndependentMusicPlayer();
                    await state.independentPlayer.initialize();
                    const demoTracks = state.independentPlayer.getDemoTracks();
                    state.independentPlayer.setPlaylist(demoTracks);
                }
                
                // Ensure we're playing before skipping to next
                if (!state.independentPlayer.isPlaying && state.independentPlayer.playlist.length > 0) {
                    await state.independentPlayer.play(state.independentPlayer.playlist[0]);
                }
                
                await state.independentPlayer.nextTrack();
                
            } else if (state.currentService === 'spotify') {
                if (!state.spotifyEnabled) {
                    console.log('Please login to Spotify first');
                    return;
                }
                await spotifyPlayer.nextTrack();
                
            } else if (state.currentService === 'appleMusic') {
                if (!appleMusicPlayer.isInitialized) {
                    console.log('Please initialize Apple Music first');
                    return;
                }
                appleMusicPlayer.nextTrack();
            }
            
            await refreshPlaybackState();
        } catch (error) {
            console.error('Next track error:', error);
        }
    }
    
    async function handlePreviousTrack() {
        try {
            if (state.currentService === 'independent') {
                if (!state.independentPlayer) {
                    state.independentPlayer = new IndependentMusicPlayer();
                    await state.independentPlayer.initialize();
                    const demoTracks = state.independentPlayer.getDemoTracks();
                    state.independentPlayer.setPlaylist(demoTracks);
                }
                
                // Ensure we're playing before skipping to previous
                if (!state.independentPlayer.isPlaying && state.independentPlayer.playlist.length > 0) {
                    await state.independentPlayer.play(state.independentPlayer.playlist[0]);
                }
                
                await state.independentPlayer.previousTrack();
                
            } else if (state.currentService === 'spotify') {
                if (!state.spotifyEnabled) {
                    console.log('Please login to Spotify first');
                    return;
                }
                await spotifyPlayer.previousTrack();
                
            } else if (state.currentService === 'appleMusic') {
                if (!appleMusicPlayer.isInitialized) {
                    console.log('Please initialize Apple Music first');
                    return;
                }
                appleMusicPlayer.previousTrack();
            }
            
            await refreshPlaybackState();
        } catch (error) {
            console.error('Previous track error:', error);
        }
    }
    
    // ========================================
    // KEYBOARD SHORTCUTS (ACCESSIBILITY)
    // ========================================
    
    document.addEventListener('keydown', (e) => {
        if (e.key === '+' || e.key === '=') {
            state.temperature++;
            updateTemperatureDisplay();
        } else if (e.key === '-' || e.key === '_') {
            state.temperature--;
            updateTemperatureDisplay();
        } else if (e.key === ' ') {
            e.preventDefault();
            elements.playPause.click();
        }
    });
    
    // ========================================
    // REFRESH PLAYBACK STATE PERIODICALLY
    // ========================================
    
    setInterval(refreshPlaybackState, 3000);
    
    // ========================================
    // SERVICE WORKER REGISTRATION
    // ========================================
    
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
            .then(registration => console.log('Service Worker registered'))
            .catch(error => console.log('Service Worker registration failed:', error));
    }
    
    console.log('HomeHarmony initialized with Spotify');
});
